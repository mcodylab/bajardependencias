trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: varcody  # Grupo de variables con credenciales de JFrog

steps:


# üîπ Descargar dependencias desde Artifactory asegurando versi√≥n correcta
- script: |
   

    echo "üìå Configurando autenticaci√≥n en JFrog Artifactory... EXPORT"
    
    # üìå 1Ô∏è‚É£ Verificar si `requirements.txt` existe
    if [ ! -f "requirements.txt" ]; then
        echo "‚ùå ERROR: No se encontr√≥ el archivo requirements.txt en el repositorio."
        exit 1
    fi
    echo "‚úÖ requirements.txt encontrado."

    # üìå 2Ô∏è‚É£ Validar si las dependencias existen en JFrog antes de instalar
    echo "üìå Validando disponibilidad de dependencias en Artifactory..."
    MISSING_PACKAGES=()
    
    while IFS= read -r package; do
        package_name=$(echo "$package" | cut -d'=' -f1)  # Extraer solo el nombre del paquete
        PKG_URL="$(PACKAGE_URL)/${package_name}/"

        # Verificar si el paquete existe en JFrog Artifactory
        if ! curl --silent --fail -u $(JFROG_USERNAME):$(JFROG_PASSWORD) "$PKG_URL" > /dev/null; then
            echo "‚ùå $package_name NO existe en Artifactory"
            MISSING_PACKAGES+=("$package_name")
        else
            echo "‚úÖ $package_name encontrado en Artifactory."
        fi
    done < <(grep -Eo '^[^#]+' requirements.txt | awk '{print $1}')

    # üìå 3Ô∏è‚É£ Si hay paquetes faltantes, detener el pipeline
    if [ ${#MISSING_PACKAGES[@]} -gt 0 ]; then
        echo "‚ùå ERROR: Las siguientes dependencias NO existen en Artifactory:"
        printf '%s\n' "${MISSING_PACKAGES[@]}"
        exit 1
    fi

    # üìå 4Ô∏è‚É£ Instalar dependencias desde Artifactory
    echo "üìå Instalando dependencias desde Artifactory..."
    pip install --no-cache-dir  --index-url=$(ARTIFACTORY_URL)  -r requirements.txt
  
    # üìå 5Ô∏è‚É£ Verificar instalaci√≥n de todas las dependencias
    echo "üìå Verificando instalaci√≥n de todas las dependencias..."
    while IFS= read -r package; do
        package_name=$(echo "$package" | cut -d'=' -f1)  # Extraer solo el nombre del paquete
        if pip list | grep -i "^$package_name "; then
            echo "‚úÖ $package_name est√° instalado"
        else
            echo "‚ùå $package_name NO est√° instalado"
        fi
    done < <(grep -Eo '^[^#]+' requirements.txt | awk '{print $1}')
  displayName: 'Descargar e instalar dependencias desde Artifactory con autenticaci√≥n'
