trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: varcody  # Grupo de variables con credenciales de JFrog

steps:


# ğŸ”¹ Descargar dependencias desde Artifactory asegurando versiÃ³n correcta
- script: |
   

    echo "ğŸ“Œ Configurando autenticaciÃ³n en JFrog Artifactory... EXPORT"
    
    # ğŸ“Œ 1ï¸âƒ£ Verificar si `requirements.txt` existe
    if [ ! -f "requirements.txt" ]; then
        echo "âŒ ERROR: No se encontrÃ³ el archivo requirements.txt en el repositorio."
        exit 1
    fi
    echo "âœ… requirements.txt encontrado."

      # ğŸ“Œ 2ï¸âƒ£ Validar si las dependencias existen en JFrog antes de instalar
    echo "ğŸ“Œ Validando disponibilidad de dependencias en Artifactory..."
    MISSING_PACKAGES=()

    PKG_URL="https://devopsm.jfrog.io/artifactory/api/pypi/pypi-local/simple/camelcase/"
    if ! curl --silent --fail -u $(JFROG_USERNAME):$(JFROG_PASSWORD) "$PKG_URL" > /dev/null; then
    echo "âŒ ERROR: La dependencia no existe en Artifactory: $PKG_URL"
    exit 1  # Falla el pipeline
    else
    echo "âœ… Dependencia encontrada en Artifactory: $PKG_URL"
    fi

    


    # ğŸ“Œ 3ï¸âƒ£ Si hay paquetes faltantes, detener el pipeline
    if [ ${#MISSING_PACKAGES[@]} -gt 0 ]; then
        echo "âŒ ERROR: Las siguientes dependencias NO existen en Artifactory:"
        printf '%s\n' "${MISSING_PACKAGES[@]}"
        exit 1
    fi

    pip install --no-cache-dir  --index-url=$(ARTIFACTORY_URL)  -r requirements.txt
  
    echo "ğŸ“Œ Verificando instalaciÃ³n de todas las dependencias..."
    while IFS= read -r package; do
        package_name=$(echo "$package" | cut -d'=' -f1)  # Extraer solo el nombre del paquete
        if pip list | grep -i "^$package_name "; then
            echo "âœ… $package_name estÃ¡ instalado"
        else
            echo "âŒ $package_name NO estÃ¡ instalado"
        fi
    done < <(grep -Eo '^[^#]+' requirements.txt | awk '{print $1}')
  displayName: 'Descargar e instalar dependencias desde Artifactory con autenticaciÃ³n'
